<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Di√°rio de Bordo">
  <link rel="apple-touch-icon" href="https://daevg.com.br/favicon.png">

  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #f4f4f4; display: flex; flex-direction: column; align-items: center; min-height: calc(100vh - 40px); justify-content: flex-start; }
    .logo { max-width: 120px; height: auto; margin-bottom: 15px; }
    .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 500px; width: 100%; box-sizing: border-box; }
    h2 { text-align: center; color: #333; margin-bottom: 20px; font-size: 20px; }
    .form-section { border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 10px; background-color: #f9f9f9; }
    .form-section h3 { margin-top: 0; color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; font-size: 16px; }
    .section-saida h3 { border-bottom-color: #4CAF50; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #007bff; font-size: 13px; }
    .section-saida label { color: #4CAF50; }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    button { background-color: #4CAF50; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold; }
    #btnRetorno { background-color: #007bff; }
    button:disabled { background-color: #ccc !important; }
    .status { display: none; background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold; border-left: 4px solid #4caf50; }
    #installBanner { position: fixed; bottom: 20px; left: 20px; right: 20px; background: #007bff; color: #fff; padding: 12px; border-radius: 10px; display: none; justify-content: space-between; align-items: center; z-index: 9999; }
    #installBanner button { background: #fff; color: #007bff; border: 0; padding: 6px 10px; border-radius: 6px; font-weight: bold; width: auto; }
  </style>
</head>

<body>
<img src="https://daevg.com.br/assets/dae-logo.svg" class="logo">

<div class="container">
  <h2>Registro de Hod√¥metro</h2>
  <div id="status" class="status">üìç Viagem Iniciada...</div>

  <div id="secaoSaida" class="form-section section-saida">
  <h3>INICIAR VIAGEM</h3>
  <form id="formSaida">
    <label for="dataSaida">Data</label>   <input type="date" id="dataSaida" required>
    <label for="veiculoSaida">Ve√≠culo</label>   <select id="veiculoSaida" required>
      <option value="" disabled selected>Selecione</option>
      <option value="" disabled selected>Selecione</option>
        <option value="QPD8801">QPD8801</option> <option value="SPH9D40">SPH9D40</option>
        <option value="SPH9D50">SPH9D50</option> <option value="SPI0E08">SPI0E08</option>
        <option value="SPI0E88">SPI0E88</option> <option value="SPI0E98">SPI0E98</option>
        <option value="SPI2F70">SPI2F70</option> <option value="SPI2F90">SPI2F90</option>
        <option value="SPI5F27">SPI5F27</option> <option value="SPI5F87">SPI5F87</option>
        <option value="SPI5F97">SPI5F97</option> <option value="SPI5G17">SPI5G17</option>
        <option value="SPI5G37">SPI5G37</option> <option value="SPI5G47">SPI5G47</option>
        <option value="SPI5G57">SPI5G57</option> <option value="SPI5G77">SPI5G77</option>
        <option value="SPI5G87">SPI5G87</option> <option value="SPI6A40">SPI6A40</option>
        <option value="SPJ5J29">SPJ5J29</option> <option value="SPL5B38">SPL5B38</option>
        <option value="SPM1A14">SPM1A14</option> <option value="SPM2F97">SPM2F97</option>
        <option value="SPM3F57">SPM3F57</option> <option value="SPM4F06">SPM4F06</option>
        <option value="SPM4F36">SPM4F36</option> <option value="SPN0E04">SPN0E04</option>
        <option value="SPN0E24">SPN0E24</option> <option value="SPN0E44">SPN0E44</option>
        <option value="SPN0E74">SPN0E74</option> <option value="SPN0F04">SPN0F04</option>
        <option value="SPN0F24">SPN0F24</option> <option value="SPN0F64">SPN0F64</option>
        <option value="SPN0F84">SPN0F84</option> <option value="SPN1A57">SPN1A57</option>
        <option value="SPN2D35">SPN2D35</option> <option value="SPN7D11">SPN7D11</option>
        <option value="SPN7D31">SPN7D31</option> <option value="SPN9G06">SPN9G06</option>
        <option value="SPQ2C69">SPQ2C69</option> <option value="SPQ2D99">SPQ2D99</option>
        <option value="SPQ2G29">SPQ2G29</option> <option value="SPQ2H09">SPQ2H09</option>
        <option value="SPQ2H89">SPQ2H89</option> <option value="SPQ2I29">SPQ2I29</option>
        <option value="SPQ2I59">SPQ2I59</option> <option value="SPQ2I69">SPQ2I69</option>
        <option value="SPQ4A97">SPQ4A97</option> <option value="SPQ5C07">SPQ5C07</option>
        <option value="SPQ5C27">SPQ5C27</option> <option value="SPQ5C37">SPQ5C37</option>
        <option value="SPQ5C47">SPQ5C47</option> <option value="SPQ5C57">SPQ5C57</option>
        <option value="SPQ5C67">SPQ5C67</option> <option value="SPQ5E97">SPQ5E97</option>
        <option value="SPQ6G69">SPQ6G69</option> <option value="SQC3D93">SQC3D93</option>
        <option value="SQC3E33">SQC3E33</option> <option value="SQC3E43">SQC3E43</option>
        <option value="SQF0G23">SQF0G23</option> <option value="SWM0D51">SWM0D51</option>    
        </select>

    <label for="motoristaSaida">Motorista</label>    <input id="motoristaSaida" required>
    <label for="destinoSaida">Destino</label>     <input id="destinoSaida" required>
    <label for="horaSaida">Hora</label>     <input type="time" id="horaSaida" required>
    <label for="hodometroSaida">Hod√¥metro Inicial</label>    <input type="number" id="hodometroSaida" required>
    <button type="submit" id="btnSaida">Registrar Sa√≠da</button>
  </form>
</div>

  <div id="secaoRetorno" class="form-section" style="display:none">
  <h3>FINALIZAR VIAGEM</h3>
  <form id="formRetorno">
    <label for="dataRetorno">Data</label>     <input type="date" id="dataRetorno" required>
    <label for="horaRetorno">Hora</label>    <input type="time" id="horaRetorno" required>
    <label for="hodometroRetorno">Hod√¥metro Final</label>    <input type="number" id="hodometroRetorno" required>
    <button type="submit" id="btnRetorno">Registrar Retorno</button>
  </form>
</div>

<div id="installBanner">
  <span>üì≤ Instale o app para melhor funcionar</span>
  <button id="btnInstall">Instalar</button>
</div>

<script>
const URL_DO_SCRIPT = "https://https://script.google.com/macros/s/AKfycbydD7i-3oyyaNR5-B2A10NQQ_w_2odb2DTw93i6jr6nGZWbkDE0x-5l4sO9vtRg5jh2/exec/exec";

// 1. Service Worker - importante 
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(() => console.log('‚úÖ SW OK'));
}

// 2. Vari√°veis de Controle
let rota = [], watchId = null;
let enviandoSaida = false, enviandoRetorno = false;

// 3. Inicializa√ß√£o
window.addEventListener('load', () => {
  const agora = new Date();
  document.getElementById('dataSaida').valueAsDate = agora;
  document.getElementById('dataRetorno').valueAsDate = agora;
  
  // Atualiza hora em tempo real
  setInterval(() => {
    const h = new Date().toTimeString().slice(0,5);
    if(document.getElementById('secaoSaida').style.display !== 'none') document.getElementById('horaSaida').value = h;
    if(document.getElementById('secaoRetorno').style.display !== 'none') document.getElementById('horaRetorno').value = h;
  }, 1000);

  // Verifica viagem ativa
  if (localStorage.getItem('viagemAtiva')) {
    mostrarLayoutRetorno();
    iniciarGPS();
  }
});

function mostrarLayoutRetorno() {
  document.getElementById('secaoSaida').style.display = 'none';
  document.getElementById('secaoRetorno').style.display = 'block';
  document.getElementById('status').style.display = 'block';
}

function iniciarGPS() {
  if (watchId) return;
  watchId = navigator.geolocation.watchPosition(p => {
    rota = JSON.parse(localStorage.getItem('rota') || '[]');
    rota.push({ lat: p.coords.latitude, lon: p.coords.longitude, t: Date.now() });
    localStorage.setItem('rota', JSON.stringify(rota));
  }, null, { enableHighAccuracy: true });
}

// 4. Fun√ß√£o de Envio (API)
async function enviarDados(dados) {
  return fetch(URL_DO_SCRIPT, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(dados)
  });
}

// 5. L√≥gica de Sa√≠da
document.getElementById('formSaida').onsubmit = async (e) => {
  e.preventDefault();
  if (enviandoSaida) return;
  enviandoSaida = true;
  const btn = document.getElementById('btnSaida');
  btn.disabled = true;
  btn.innerText = "Enviando...";

  navigator.geolocation.getCurrentPosition(async (p) => {
    const payload = {
      action: 'saida',
      dataSaida: document.getElementById('dataSaida').value,
      veiculo: document.getElementById('veiculoSaida').value,
      motorista: document.getElementById('motoristaSaida').value,
      destino: document.getElementById('destinoSaida').value,
      horaSaida: document.getElementById('horaSaida').value,
      hodometroSaida: document.getElementById('hodometroSaida').value,
      localizacaoSaida: `${p.coords.latitude},${p.coords.longitude}`
    };

    try {
      await enviarDados(payload);
      localStorage.setItem('viagemAtiva', payload.veiculo); // Salva apenas o texto da placa
      localStorage.setItem('rota', '[]');
      alert('‚úÖ Sa√≠da registrada com sucesso!');
      location.reload(); 
    } catch (err) {
      alert('Erro ao enviar: ' + err);
      enviandoSaida = false;
      btn.disabled = false;
      btn.innerText = "Registrar Sa√≠da";
    }
  }, () => {
    alert('‚ùå GPS Necess√°rio');
    enviandoSaida = false;
    btn.disabled = false;
  });
};

// 6. L√≥gica de Retorno
document.getElementById('formRetorno').onsubmit = async (e) => {
  e.preventDefault();
  if (enviandoRetorno) return;
  enviandoRetorno = true;
  const btn = document.getElementById('btnRetorno');
  btn.disabled = true;
  btn.innerText = "Finalizando...";

  const placaAtiva = localStorage.getItem('viagemAtiva');
  const historico = localStorage.getItem('rota') || '[]';

  navigator.geolocation.getCurrentPosition(async (p) => {
    const payload = {
      action: 'retorno',
      veiculo: placaAtiva,
      dataRetorno: document.getElementById('dataRetorno').value,
      horaRetorno: document.getElementById('horaRetorno').value,
      hodometroRetorno: document.getElementById('hodometroRetorno').value,
      localizacaoRetorno: `${p.coords.latitude},${p.coords.longitude}`,
      historicoRota: historico
    };

    try {
      await enviarDados(payload);
      alert('‚úÖ Viagem finalizada!');
      localStorage.clear();
      location.reload();
    } catch (err) {
      alert('Erro ao finalizar');
      enviandoRetorno = false;
      btn.disabled = false;
    }
  });
};

// 7. PWA Install (Android)
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBanner').style.display = 'flex';
});

document.getElementById('btnInstall').addEventListener('click', () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => {
      document.getElementById('installBanner').style.display = 'none';
      deferredPrompt = null;
    });
  }
});
</script>
</body>
</html>
